---
import Layout from '../layouts/Layout.astro';
import ProjectCard from '../components/ProjectCard.astro';
import { getCollection } from 'astro:content';

// Get all projects
const allProjects = await getCollection('projects', ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Sort projects by date (newest first)
const projects = allProjects.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get unique tags
const allTags = [...new Set(projects.flatMap(project => project.data.tags))].sort();

// Sample projects (use these if no projects exist yet)
const sampleProjects = [
  {
    title: "E-commerce Website",
    description: "A fully responsive e-commerce platform built with React, Node.js, and MongoDB. Features include user authentication, product filtering, cart functionality, and payment processing.",
    image: "https://images.pexels.com/photos/39284/macbook-apple-imac-computer-39284.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["React", "Node.js", "MongoDB", "Stripe"],
    link: "#",
    github: "#"
  },
  {
    title: "Portfolio Website",
    description: "A modern portfolio website built with Astro and Tailwind CSS. Features a responsive design, dark mode, and optimized performance.",
    image: "https://images.pexels.com/photos/196644/pexels-photo-196644.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["Astro", "Tailwind CSS", "JavaScript"],
    link: "#",
    github: "#"
  },
  {
    title: "Task Management App",
    description: "A task management application with drag-and-drop functionality, user authentication, and real-time updates using Firebase.",
    image: "https://images.pexels.com/photos/9134/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["React", "Firebase", "CSS"],
    link: "#",
    github: "#"
  },
  {
    title: "Weather Application",
    description: "A weather application that provides current weather information and forecasts based on location. Built with Vue.js and OpenWeather API.",
    image: "https://images.pexels.com/photos/1118873/pexels-photo-1118873.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["Vue.js", "API", "CSS"],
    link: "#",
    github: "#"
  },
  {
    title: "Blog Platform",
    description: "A blog platform with content management system, user authentication, and comment functionality.",
    image: "https://images.pexels.com/photos/261662/pexels-photo-261662.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["React", "Node.js", "MongoDB"],
    link: "#",
    github: "#"
  },
  {
    title: "Fitness Tracker",
    description: "A fitness tracking application that allows users to track workouts, set goals, and view progress over time.",
    image: "https://images.pexels.com/photos/841130/pexels-photo-841130.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2",
    tags: ["React Native", "Firebase", "Redux"],
    link: "#",
    github: "#"
  }
];

// Use sample projects if no real projects exist
const displayProjects = projects.length > 0 ? projects : sampleProjects;
---

<Layout title="Portfolio - My Projects" description="Explore my portfolio of web development projects, including websites, applications, and design work.">
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Header -->
    <header class="max-w-3xl mx-auto text-center mb-16">
      <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-4">My Portfolio</h1>
      <div class="h-1 w-20 bg-primary-500 mx-auto mb-6 rounded-full"></div>
      <p class="text-xl text-gray-700 dark:text-gray-300">
        A showcase of my projects and work in web development.
      </p>
    </header>
    
    <!-- Filter by tags -->
    <div class="max-w-5xl mx-auto mb-12">
      <div class="flex flex-wrap justify-center gap-2 mb-8" id="tag-filters">
        <button 
          class="tag-filter active px-4 py-2 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 text-sm font-medium hover:bg-primary-200 dark:hover:bg-primary-800/30 transition-colors"
          data-tag="all"
        >
          All Projects
        </button>
        
        {allTags.length > 0 ? allTags.map(tag => (
          <button 
            class="tag-filter px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            data-tag={tag}
          >
            {tag}
          </button>
        )) : (
          <button 
            class="tag-filter px-4 py-2 rounded-full bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
            data-tag="sample"
          >
            Sample
          </button>
        )}
      </div>
    </div>
    
    <!-- Projects Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8" id="projects-grid">
      {projects.length > 0 ? (
        projects.map(project => (
          <div class="project-card" data-tags={project.data.tags.join(',')}>
            <ProjectCard
              title={project.data.title}
              description={project.data.description}
              image={project.data.image}
              tags={project.data.tags}
              link={project.data.link}
              github={project.data.github}
              carousel={project.data.carousel}
            />
          </div>
        ))
      ) : (
        sampleProjects.map(project => (
          <div class="project-card" data-tags={project.tags.join(',')}>
            <ProjectCard
              title={project.title}
              description={project.description}
              image={project.image}
              tags={project.tags}
              link={project.link}
              github={project.github}
            />
          </div>
        ))
      )}
    </div>
    
    <!-- No results message -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-xl text-gray-500 dark:text-gray-400">No projects match the selected filter.</p>
      <button 
        id="clear-filters" 
        class="mt-4 px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors"
      >
        Clear Filters
      </button>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('astro:page-load', () => {
    const tagFilters = document.querySelectorAll('.tag-filter');
    const projectCards = document.querySelectorAll('.project-card');
    const noResults = document.getElementById('no-results');
    const clearFilters = document.getElementById('clear-filters');
    
    // Filter projects by tag
    function filterProjects(tag) {
      let visibleCount = 0;
      
      projectCards.forEach(card => {
        const cardTags = card.dataset.tags ? card.dataset.tags.split(',') : [];
        
        if (tag === 'all' || cardTags.includes(tag)) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });
      
      // Show/hide no results message
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
      
      // Update active filter button
      tagFilters.forEach(btn => {
        if (btn.dataset.tag === tag) {
          btn.classList.add('active', 'bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
          btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        } else {
          btn.classList.remove('active', 'bg-primary-100', 'dark:bg-primary-900/30', 'text-primary-700', 'dark:text-primary-300');
          btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        }
      });
    }
    
    // Add click event to filter buttons
    tagFilters.forEach(button => {
      button.addEventListener('click', () => {
        const tag = button.dataset.tag;
        filterProjects(tag);
      });
    });
    
    // Clear filters
    if (clearFilters) {
      clearFilters.addEventListener('click', () => {
        filterProjects('all');
      });
    }
  });
</script>